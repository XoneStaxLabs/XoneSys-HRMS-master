@{
    ViewBag.Title = "Create";
}
<script src="~/plugins/Toast/src/jquery.toast.js"></script>
<link href="~/plugins/Toast/src/jquery.toast.css" rel="stylesheet" />

<link href="~/jqwidgets/jqwidgets/styles/jqx.base.css" rel="stylesheet" />
<link href="~/jqwidgets/jqwidgets/styles/jqx.metro.css" rel="stylesheet" />
<script src="~/jqwidgets/jqwidgets/jqxcore.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxdata.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxbuttons.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxscrollbar.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxbuttons.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxpanel.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxtree.js"></script>
<script src="~/jqwidgets/jqwidgets/jqxcheckbox.js"></script>

<script type="text/javascript">

    function GetCitizenship() {
        var ddlBox = $("#CizenID");

        $.ajax({
            url: "/ApplicationUser/GetCitizenship",
            async: false
        }).done(function (data) {

            ddlBox.empty();
            ddlBox.append('<option value="0">--Select--</option>');

            $.each(data, function (i, item) {
                ddlBox.append('<option value=' + item.CizenID + '>' + item.Citizen + '</option>');
            });

        });
    }

    function GetDesignation() {
        var ddlBox = $("#DesigID");

        $.ajax({
            url: "/ApplicationUser/GetDesignation",
            async: false
        }).done(function (data) {

            ddlBox.empty();
            ddlBox.append('<option value="0">--Select--</option>');

            $.each(data, function (i, item) {

                ddlBox.append('<option value=' + item.DesigID + '>' + item.DesigName + '</option>');
            });

        });

    }

    function GetMenuMasterData(AppUser_ID) {
        $.ajax({
            type: "GET",
            url: "/ApplicationUser/GetjsonData",
            data: { AppUserID: AppUser_ID, DesigID: $("#DesigID").val(), Flag:0 },
            async: false
        }).done(function (data) {
            $('#jqxTree').jqxTree('clear');
            var dataAdapter = new $.jqx.dataAdapter(data);
            dataAdapter.dataBind();
            var records = dataAdapter.getRecordsHierarchy('id', 'parentid', 'items', [{ name: 'text', map: 'label' }]);
            $('#jqxTree').jqxTree({ source: records, width: '300px', theme: 'metro' });
        });
    } 

    $(document).ready(function () {
        GetCitizenship();
        GetDesignation();

        $("#BtnUserPermission").hide();
        $('#CizenID').change(function () {
            if ($(this).val() != 0) {
                $("label[for='CizenID']").text('');
            }
            else {
                $("label[for='CizenID']").text('Please select an item from the dropdown list.');
            }

        })

        $('#DesigID').change(function () {
            if ($(this).val() != 0) {
                $("label[for='DesigID']").text('');
            }
            else {
                $("label[for='DesigID']").text('Please select an item from the dropdown list.');
            }

        })

        $("#BtnAddUserprofile").click(function (event) {

            $.validator.addMethod("custom_number", function (value, element) {
                return this.optional(element) || value === "NA" ||
                    value.match(/^[0-9,\+-]+$/);
            }, "Please enter a valid number");
            $.validator.addMethod("check_item_dropdown", function (value, element) {
                return this.optional(element) || value != 0;
            }, "Please select an item from the dropdown list.");

            //initilize validation plugin on this form.
            $("#UserProfile").validate({
                rules: {
                    AppMobile: {
                        required: true,
                        custom_number: true,
                        minlength: 8,
                        maxlength: 15
                    },
                    CitizenID: {
                        check_item_dropdown: true,
                        required: true,
                    },
                    DesigID: {
                        check_item_dropdown: true,
                        required: true,
                    },
                    AppEmail: {
                        required: true
                    }
                }

            });           

            //run validation process
            if ($('#UserProfile').valid()) {

                var formData = new FormData();

                var totalFiles = document.getElementById("newdoc").files.length;
            
                if (totalFiles > 0) {

                    for (var i = 0; i < totalFiles; i++) {
                        var file = document.getElementById("newdoc").files[i];                        
                        formData.append("FileUpload", file);
                        formData.append("AppFirstName", $("#AppFirstName").val());
                        formData.append("CizenID", $("#CizenID").val());
                        formData.append("DesigID", $("#DesigID").val());
                        formData.append("AppAddress", $("#AppAddress").val());
                        formData.append("AppMobile", $("#AppMobile").val());
                        formData.append("AppUserName", $("#AppUserName").val());
                        formData.append("AppPwd", $("#AppPwd").val());
                        formData.append("AppEmail", $("#AppEmail").val());
                        formData.append("AppGender", $("#AppGender").val());
                        formData.append("AppUID", 0);
                    }

                    $.ajax({

                        type: "POST",
                        url: "/ApplicationUser/ManageApplicationUser",
                        data: formData,
                        dataType: 'json',
                        contentType: false,
                        processData: false
                    }).done(function (data) {
                        
                        $.toast({
                            text: data.Message,
                            position: 'top-right',
                            hideAfter: 3000,
                            showHideTransition: 'slide',
                            loader: false,
                        })
                        if (data.Result > 0) {

                            $("#HIdAppUserID").val(data.Result);
                            GetMenuMasterData(0);
                            $('.nav-tabs > .active').next('li').find('a').trigger('click');
                            $("#BtnUserPermission").show();
                        }
                     
                     })
                }
                else {
                    var formData = new FormData();
                    formData.append("AppFirstName", $("#AppFirstName").val());
                    formData.append("CizenID", $("#CizenID").val());
                    formData.append("DesigID", $("#DesigID").val());
                    formData.append("AppAddress", $("#AppAddress").val());
                    formData.append("AppMobile", $("#AppMobile").val());
                    formData.append("AppUserName", $("#AppUserName").val());
                    formData.append("AppPwd", $("#AppPwd").val());
                    formData.append("AppEmail", $("#AppEmail").val());
                    formData.append("AppGender", $("#AppGender").val());
                    formData.append("AppUID", 0);

                    $.ajax({

                        type: "POST",
                        url: "/ApplicationUser/ManageApplicationUser",
                        data: formData,
                        dataType: 'json',
                        contentType: false,
                        processData: false
                    }).done(function (data) {

                        $.toast({
                            text: data.Message,
                            position: 'top-right',
                            hideAfter: 3000,
                            showHideTransition: 'slide',
                            loader: false,
                        })
                        if (data.Result > 0) {

                            $("#HIdAppUserID").val(data.Result);
                            GetMenuMasterData(0);
                            $('.nav-tabs > .active').next('li').find('a').trigger('click');
                            $("#BtnUserPermission").show();
                        }

                    })

                    //$.toast({

                    //    text: "Please choose a File",
                    //    position: 'top-right',
                    //    hideAfter: 3000,
                    //    showHideTransition: 'slide',
                    //    loader: false,
                    //})
                }
            }               
        });
        // create jqxTree
        $('#jqxTree').jqxTree({ height: '400px', hasThreeStates: true, checkboxes: true, width: '330px' });
        $('#jqxTree').css('visibility', 'visible');

        $("#BtnUserPermission").click(function () {
             
            var items = $("#jqxTree").jqxTree('getItems');
            var checkedItems = new Array();
            $.each(items, function () {
                if (this.checked == true || this.checked == null) {
                    checkedItems.push(this.id);
                }
            });
            $.ajax({
                type: "POST",
                url: "/ApplicationUser/ManageUserPermission",
                data: { Data: JSON.stringify(checkedItems), AppUserID: $("#HIdAppUserID").val(), Flag: 1 },
                async: false
            }).done(function (data) {

                    $.toast({
                        text: data.Message,
                        position: 'top-right',
                        hideAfter: 2000,
                        showHideTransition: 'slide',
                        loader: false,
                    })
                    if (data.Result == 1) {
                        window.location.href = "/ApplicationUser/Index"
                    }

                })
            
        });
        
    })
</script>

<section class="content-header" id="Candidate">
    <h1>
        <i class="fa fa-user-plus"></i>&nbsp;
        User
    </h1>

    <ol class="breadcrumb">
        <li><a href="/ApplicationUser/Index"><i class="fa fa-arrow-left"></i>&nbsp;&nbsp;Back &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a></li>
    </ol>
</section>

 
<section class="newforms">
    <div class="tabsnew">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs " role="tablist">
            <li role="presentation" class="active"><a href="#profile" aria-controls="home" role="tab" data-toggle="tab">User Data</a></li>
            <li role="presentation" id="Citizentab"><a href="#permission" aria-controls="Citizenship" role="tab" data-toggle="tab">User Permission</a></li>            
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">

            <div role="tabpanel" class="tab-pane active" id="profile">
                <form class="" action="#" id="UserProfile" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Name</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control required" id="AppFirstName" name="AppFirstName" placeholder="Name" autocomplete="off">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Nationality</label>
                                <div class="col-sm-8">
                                    <select class="form-control" name="CitizenID" id="CizenID"></select>
                                </div>
                            </div>

                            @*<div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">User Type</label>
                                <div class="col-sm-8 selectCat">
                                    <select class="form-control required" name="UserType" id="UserType">
                                    
                                        <option value="0">Application</option>
                                    </select>
                                </div>
                            </div>*@

                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Designation</label>
                                <div class="col-sm-8">
                                    <select class="form-control" name="DesigID" id="DesigID"></select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Address</label>
                                <div class="col-sm-8">
                                    <textarea class="form-control" rows="3" name="AppAddress" id="AppAddress" placeholder="Address"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Mobile</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control required" name="AppMobile" placeholder="Mobile" id="AppMobile" autocomplete="off">
                                    @*<span id="mob_unique" style="color:red">Mobile number already registerd</span>*@
                                </div>
                            </div>
                            
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Username</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control required" name="AppUserName" placeholder="Username" id="AppUserName" autocomplete="off">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Password</label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control required" name="AppPwd" placeholder="Password" id="AppPwd" autocomplete="off">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Email</label>
                                <div class="col-sm-8">
                                    <input type="email" class="form-control email" name="AppEmail" placeholder="Email" id="AppEmail" autocomplete="off">
                                    @*<span id="mail_unique" style="color:red">Email already registerd</span>*@
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Gender</label>
                                <div class="col-sm-8 ">

                                    <select class="form-control" name="AppGender" id="AppGender">
                                        <option>Male</option>
                                        <option>Female</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-4 control-label">Upload Photo</label>
                                <div class="col-sm-8">
                                    <input type="file" id="newdoc" name="DocFiles[]" >
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="divider">

                    <div class="text-right">
                        <button type="button" class="btn btn-sm btn-success" id="BtnAddUserprofile">Save & Continue <span>&nbsp;</span><i class="fa fa-floppy-o"></i></button>
                    </div>
                </form>
            </div>

            <div role="tabpanel" class="tab-pane fade" id="permission">

                <form class="" action="#" id="FrmIdUserPermission">
                    <input type="hidden" id="HIdAppUserID" name="AppUserID">
                    <div class="col-md-12">
                        <div class="col-md-6">
                            <h3 class="box-title">Menu Permission</h3>
                            <hr />
                            <div id='jqxWidget'>
                                <div style='float: left;'>
                                    <div id='jqxTree' style='visibility: hidden; float: left; margin-left: 20px;'>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-left">
                        <button type="button" class="btn btn-sm btn-success" id="BtnUserPermission">Save<i class="fa fa-floppy-o"></i></button>
                    </div>

               </form>
            </div>
             

        </div>
    </div>
</section>